
function loadNightMode() {
    if (new Date().getHours() > 18 || new Date().getHours() < 9) {
        document.body.classList.add('night');
        loadCSS('/assets/css/prism-duotone-sea.css');
    } else {
        document.body.classList.remove('night');
        loadCSS('/assets/css/prism-duotone-light.css');
    }
}
function loadCSS(url) {
    var link = document.createElement('link');
    {
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = url;
    }
    document.querySelector('head').appendChild(link);

}

function showDialog(type, msg) {
    var modal = document.getElementById("myModal")
    if (!modal) {
        return;
    }
    var colors = {
        "error": "#eb3941"
    }
    var types = {
        'error': '错误'
    }
    modal.style.display = "block";
    modal.querySelector(".dialog .head").innerHTML = types[type];
    modal.querySelector(".dialog .message").innerHTML = msg;
    modal.querySelector(".dialog button").style.background = colors[type];
    modal.querySelector(".dialog button").style.borderColor = colors[type];
}
function hideDialog() {
    var modal = document.getElementById("myModal")
    if (!modal) {
        return;
    }
    modal.style.display = "none";
}

async function request(url, params) {
    const message = {
        50000: '服务器出错，烦请报告管理员',
        40000: '提交的数据有误',
        40001: '代码内容不能为空',
        40002: '语言无效'
    }
    async function checkStatus(response) {
        if (response.status >= 200 && response.status < 300) {
            return response;
        }
        const error = new Error(response.statusText);
        error.response = response;
        const ret = await response.json();
        showDialog("error", message[ret.code]);
        console.log(ret);
        throw error;
    }

    async function parseJSON(response) {
        return response.json();
    }

    return fetch(url, params).then(checkStatus).then(parseJSON)
}

function getHistory() {
    return JSON.parse(localStorage.getItem("pastex_history")) || {}
}

async function share() {
    const ret = await request('/share', {
        method: 'POST',
        body: new FormData(document.getElementById("share-form"))
    });
    let ls = getHistory()
    ls[ret.sid] = ret.pass
    localStorage.setItem("pastex_history", JSON.stringify(ls))
    window.location.href = "/share/" + ret.sid;
}
hideDialog();
loadNightMode();